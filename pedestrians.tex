\subsection{Darstellung der Fußgängerdaten}


Die Visualisierung der Fußgänger kann auf zwei Arten erfolgen. Entweder wird jeder Fußgänger als eigenes Model dargestellt, oder es wird ein Partikelsystem verwendet, das für große Mengen an Fußgängerobjekten geeignet ist. Hier wird eine vereinfachte Darstellung als Kugel verwendet. Je nach verfügbarer Rechenleistung sollte ab 1000 Fußgängern die Darstellung als Partikelsystem verwendet werden, um die Animation noch flüssig abspielen zu können.


\subsubsection{Fußgänger als 3D-Objekte}

Wie bei der Darstellung von Bäumen und Büschen gibt es für die Fußgängerfiguren ein Modell im COLLADA-Format, das geladen wird. Zu Beginn der Szene wird die benötigte Anzahl an Instanzen dieses Modells erzeugt, jedoch ist die Sichtbarkeit der Modelle noch deaktiviert. Somit ist es während des Ablaufs der Animation schnell möglich, die Modelle an der entsprechenden Position einzublenden. Da das Ändern der Sichtbarkeit wesentlich schneller geschieht als das Erzeugen neuer Objekte, kann so ein flüssiger Ablauf der Animation gewährleistet werden.

Damit das Fußgängermodell in Bewegungsrichtung blickt, muss das Modell an der y-Achse gedreht werden. Die Blickrichtung wird als Vektor zwischen der aktuellen Position und der position im folgenden Schritt beschrieben. Der Differenzwinkel zwischen der aktuellen Drehung und der Blickrichtung ist die anzuwendende Drehung. Falls kein folgender Simulationsschritt verfügbar ist, da es sich beispielsweise um den letzten Animationsschritt handelt, wird die Drehung aus dem vorherigen Schritt beibehalten. Das Fußgängermodell wird wie auch der Rest der Geometrie mit dem globalen Skalierungsfaktor skaliert. Im Maßstab gesehen hat das Modell eine reele Höhe von 1,75m.

Das Modell des Fußgängers besteht aus einer geringen Anzahl Vertices, um die Berechnungsdauer möglichst kurz zu halten. Trotz der geringen Auflösung sollte auf gewöhnlichen Rechnern ab 1000 Fußgängern die Darstellung als Partikelsystem verwendet werden.

\subsubsection{Fußgänger als Partikelsystem}

Für die Darstellung von Effekten oder vieler kleiner Elemente gibt es in der Computergrafik sogenante Partikelsysteme. Haupteinsatzzweck ist die Berechnung von Feuer, Rauch, Nebel oder Wasser. Ein Partikelsystem besteht aus einer großen Menge einzelner Partikel, von denen jeder eigene Eigenschaften haben kann. Der Vorteil der Verwendung eines Partikelsystems gegenüber einzelnen Objekten ist die Minimierung der Objektanzahl. Ein Partikelsystem ist technisch nur ein einziges Objekt. Jeder Partikel wird als Vertex dieses Objekts im Vertex-Array an die Grafikkarte übergeben (vgl. Kapitel \ref{pipeline}). Zur Darstellung der Partikel gibt es verschiedene Möglichkeiten. Die Partikel können als einfacher Punkt angezeigt werden, es kann eine Grafikdatei an Stelle des Vertex angezeigt werden und in manchen 3D-Bibliotheken können auch 3D-Modelle an jedes Vertex gezeichnet werden, jedoch unterstützt THREE.js das nicht.

Deshalb wird in SumoViz3D die Anzeige von Grafikdateien an jedem Vertex genutzt. Nach der Berechnung der Position des Partikels wird die Grafik entsprechend der Tiefe skaliert und dann frontal ohne Drehung an dieser Stelle angezeigt. Dieses Verfahren wird als \emph{Billboard} (engl. für Plakatwand) bezeichnet, da die Grafik eigentlich nur zweidimensional ist, sich aber nicht mitdreht und deshalb immer nur frontal auf den Betrachter zeigt. Damit in der Darstellung nicht auffällt, das es sich um eine 2D-Grafik handelt wird die Grafik einer Kugel verwendet. Eine Kugel hat aus jedem Betrachtungswinkel den gleichen Umriss und so fällt nicht auf, dass die Grafik nur stets frontal zur sehen ist.

Die Billboard-Grafik ist ein transparentes PNG-Bild einer weißen Kugel, auf der Schattierungen zu sehen sind. Neben dem Vertex-Array wird ein Color-Array angelegt, das zum jeweiligen Index die Farbe des entsprechenden Partikel speichert. Diese Farbe wird auf das Billboard multipliziert und so werden vor allem die hellen Flächen der Kugel entsprechend eingefärbt.





\subsubsection{Einfärbung der Fußgängerobjekte}

Unabhängig von den Darstellung der Fußgänger als 3D-Modell oder als Partikel gibt es verschiedene Möglichkeiten die Fußgänger einzufärben und damit weitere Daten zu visualisieren.

\paragraph{Einfärbung nach Dichte}\label{colorcap}
\begin{wrapfigure}{r}{0.4\textwidth}
  \includegraphics[width=0.4\textwidth]{media/colorcone.png}
  \caption{HSV-Farbraum}
  \label{zfight}
\end{wrapfigure}
Standardeinstellung ist die Einfärbung nach Dichte. Pro Zeitpunkt und Fußgänger sind diese Daten schon in der Ausgabedatei gespeichert und müssen nicht mehr berechnet werden. Der Wertebereich ist mit $0.0 \le density \le 1.0$ definiert. Zur Farbgebung der Fußgänger ist die Verwendung des HSV-Farbraums geeignet, zudem THREE.js die Methode \verb+setHSV(h,s,v)+ implementiert. Der Farbwert wird beim HSV-Farbraum über den Farbton $H$ (engl. \emph{hue}), die Farbsättigung $S$ (engl. \emph{saturation}) und den Hellwert $V$ (engl. \emph{value}) bestimmt. Während $S$ und $V$ als Prozentwerte angegeben werden, wird für $H$ eine Farbwinkelangabe auf dem Farbkreis verwendet.

Für die Dichte soll der Farbton zwischen grün ($H=105^\circ$) für einen Wert von $0.0$ und rot ($H=0^\circ$) für den Maximalwert von $1.0$ variieren. Sättigung und Hellwert bleiben unverändert. Der Funktionsaufruf muss für jeden Fußgänger zu jedem Zeitschritt der Simulation erfolgen. Das Setzen des Farbwerts bei Verwendung eines Partikelsystems für den Partikel $i$ sieht wie folgt aus: \verb+particles.colors[i].setHSV(105-105*density,1,1);+


\paragraph{Einfärbung nach Geschwindigkeit}

Es ist möglich die Geschwindigkeit der Fußgänger ebenfalls farblich zu kodieren. Jedoch ist diese Information nicht in den Datensätzen enthalten und muss in Echtzeit berechnet werden. Dazu wird die Distanz zwischen den aktuellen Koordinaten und den Koordinaten des vorhergehenden Zeitpunkts berechnet. Je höher die zurückgelegte Distanz, um so höher auch die Geschwindigkeit. Empirisch wurde ermittelt, dass die zurückgelegte Distanz zwischen zwei aufeinander folgenden Zeitpunkten zwischen $0$ und $30$ liegt. Entsprechend wird mit einer ähnlichen Funktion wie bei der Einfärbung nach Dichte der Farbwert des Fußgängers bestimmt. Niedrige Geschwindigkeiten werden in rot ($H=0^\circ=360^\circ$), hohe Geschwindigkeiten in blau ($H=240^\circ$) dargestellt. War der Fußgänger im vorherigen Schritt nicht sichtbar, ist es nicht möglich eine Geschwindigkeit zu berechnen und der Fußgänger wird in grau dargestellt.


\paragraph{Einfärbung nach Gruppen}
\label{colorgroups}
In der Ausgabedatei kann ein Datenblock angelegt werden, in dem einzelne Fußgänger zu Gruppen geordnet werden können. Gruppen haben Auswirkungen auf die Simulationsergebnisse und sind deshalb auch bei der Auswertung interessant. Die Gruppenzugehörigkeit kann sich, sofern vorhanden, auch farblich visualisieren lassen. Bei der Farbverteilung der Gruppen wird bei $H_0=0^\circ$ begonnen und nach der Funktion $H_i=(i*173)mod360$ die weiteren Farbwerte vergeben. Durch die Verwendung der Primzahl $173$ ist bereits bei zwei Gruppen eine gute Unterscheidung der Farben möglich, bei vielen Gruppen die Wahrscheinlichkeit einer doppelten Verwendung einer Farbe niedrig und die Verteilung über das Farbspektrum groß. Die Einfärbung der Fußgängerobjekte nach Gruppenzugehörigkeit muss nur einmal zu Beginn durchgeführt werden und ändert sich während der Visualisierung nicht mehr.

